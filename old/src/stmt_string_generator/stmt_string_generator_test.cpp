#include <string>
#include <iostream>

#include "stmt_string_generator.hpp"

using namespace std;
using namespace ashs;

// Test functions
static void FunctionsTest();
static void AddStringFuncTest();
static void RemoveStringFuncTest();

// Test StringFuncs
static string& Func1(const string& col, const string& val);
static string& Func2(const string& col, const string& val);

// StringFunc outputs
static const string func1Str("This string is generated by Func1. col: func1_col. val: func1_val");
static const string func2Str("This string is generated by Func2");

int main()
{
    FunctionsTest();
    AddStringFuncTest();
    RemoveStringFuncTest();

    return 0;
}

// Test functions //////////////////////////////////////////////////////////////////////////

static void FunctionsTest()
{
    string str;
    size_t errors = 0, passes = 0;
    
    str = (Func1("func1_col", "func1_val"));
    0 == str.compare(func1Str) ? ++passes : ++errors;

    str = Func2("func2_col", "func2_val");
    0 == str.compare(func2Str) ? ++passes : ++errors;

    cout << "Functions Test: "
    << passes << " successful. "
    << errors << " errors." << endl;
}

static void AddStringFuncTest()
{
    string str;
    size_t errors = 0, passes = 0;
    
    StmtStringGenerator strGen;

    // add functions and generate by key
    strGen.AddStringFunc(1, &Func1);
    strGen.AddStringFunc(2, &Func2);

    str = strGen.GenerateString(1, "func1_col", "func1_val");
    0 == str.compare(func1Str) ? ++passes : ++errors;

    str = strGen.GenerateString(2, "func2_col", "func2_val");
    0 == str.compare(func2Str) ? ++passes : ++errors;

    // Generate non-existing key
    str = strGen.GenerateString(3, "func3_col", "func3_val");
    0 == str.compare("") ? ++passes : ++errors;

    // add a function with an occupied key
    strGen.AddStringFunc(2, &Func1);
    str = strGen.GenerateString(2, "func1_col", "func1_val");
    0 == str.compare(func2Str) ? ++passes : ++errors;

    // print report
    cout << "AddStringFunc Test: "
    << passes << " successful. "
    << errors << " errors." << endl;
}

static void RemoveStringFuncTest()
{
    string str;
    size_t errors = 0, passes = 0;
    
    StmtStringGenerator strGen;

    // add functions, remove and generate by key
    strGen.AddStringFunc(1, &Func1);
    strGen.AddStringFunc(2, &Func2);

    strGen.RemoveStringFunc(2);
    str = strGen.GenerateString(1, "func1_col", "func1_val");
    0 == str.compare(func1Str) ? ++passes : ++errors;
    str = strGen.GenerateString(2, "func2_col", "func2_val");
    0 == str.compare("") ? ++passes : ++errors;

    // Remove with non-existing key
    try
    {
        strGen.RemoveStringFunc(3);
    }
    catch(const std::out_of_range& e)
    {
        ++errors;
    }
    ++passes;

    // print report
    cout << "RemoveStringFunc Test: "
    << passes << " successful. "
    << errors << " errors." << endl;
}

// Test StringFuncs ////////////////////////////////////////////////////////////////////////

static string& Func1(const string& col, const string& val)
{
    string* str = new string("This string is generated by Func1");
    str->append(". col: ");
    str->append(col);
    str->append(". val: ");
    str->append(val);

    return *str;
}

static string& Func2(const string& col, const string& val)
{
    string* str = new string("This string is generated by Func2");

    return *str;
}